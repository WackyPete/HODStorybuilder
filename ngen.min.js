!function(){"use strict";function t(){var t=$("input[type=submit][clicked=true]").val();return $("input[type=submit]").removeAttr("clicked"),t}function e(){v=1,$("#StoryInput").val(""),$("#StoryOutput").val(""),$(".s-block").remove(),$(".txtCount").text(0),$(".tagdump").empty(),$("#StoryGroup").val("")}function a(t,e){$.ajax({type:"GET",cache:!1,url:t,dataType:"xml",success:function(t){i(t,e),$(".upload-progress").hide()},error:function(t){console.log("AJAX error in request: "+JSON.stringify(t,null,2))}})}function r(t){c=t.target.files}function n(){var t=h.val(),e=t.replace(/(\[.*?\]|\{.*?\}|\*.*?\*)\s?/g,function(t){return t.toUpperCase()});h.val(e)}function i(t,a){var r=[],n=[],i=$(t).find("Story").text(),l=$(t).find("Group").text();$(t).find("Story_Fields").each(function(){$(this).find("Field").each(function(){var t=$(this).attr("Name");r[t]=[],$(this).find("Value").each(function(){var e=$(this).text();r[t].push(e)})})}),i.length>0&&!a&&(e(),$("#StoryInput").val(i),$("#StoryGroup").val(l),$(".txtCount").text(i.length)),$(".s-tag").each(function(){var t=$(this).val();""!=t&&n.push(t)});for(var s in r){var c=v;n.indexOf(s)>=0||($("#AddTag").trigger("click"),$(".s-tag").each(function(){var t=$(this).val(),e=1;if(""==t){$(this).val(s);for(var a in r[s])e>1&&$("#"+c+"_TagValue").trigger("click"),$("#"+c+"_TagValue_"+e).val(r[s][a]),e++}}))}$("#InputFile").empty(),o()}function l(t){t.preventDefault();var e="";"tClear"==$(this).attr("class")?confirm("Do you want to delete this tag list?")&&(e=$(this).children().attr("class").split(" ")[0],$("#"+e).remove(),o()):(e=$(this).children().attr("class"),$("#"+e).remove())}function o(){var t=$(".tagdump");t.empty(),$(".s-tag").each(function(){var e=$(this).val().toUpperCase(),a=$(this).attr("id");t.append('<a href="#'+a+'" id="'+e+'" class="tagdrop">['+e+"]</a> ")})}function s(t,e){n();var a=$("#story").serializeArray();$.ajax({type:"POST",url:u+"SubmitStory.php?submit="+e,data:{output:JSON.stringify(a)},success:function(t){return t.indexOf("!TagError")>=0?alert(t):("Preview"==e?$("#StoryOutput").val(t):h.val().length<=f?alert("You have not made a story! Please enter a story and try export again"):window.location=u+"Download.php",void o())}})}var c,u="./lib/",p="./uploads/Story.xml",d="./samples/",v=1,f=44,h=$("#StoryInput");h.bind("input propertychange",function(){var t=1500,e=$(this).val().length,a=$(".txtCount");a.text(e),e>=t?a.css("color","red"):a.css("color","green")}),""==h.val()&&null!=h&&h.val("[BOSSNAME] [BOSSTYPE] [REWARDNAME] [MAPNAME]"),$(".tagdrop").click(function(t){t.preventDefault();var e=h.prop("selectionStart"),a="["+$(this).attr("id").toUpperCase()+"]",r=h.val().substr(0,e)+a+h.val().substr(e);h.val(r)}),$("#story").on("keypress",function(t){if(13===t.keyCode){var e=$(":focus"),a=e.attr("id");if("StoryInput"==a||"StoryOutput"==a)return;t.preventDefault(),a=a.substr(0,a.lastIndexOf("_"));var r=$("#"+a).trigger("click").get(0).clickid;$("#"+r).focus()}}),$("#preview-story").click(function(t){t.preventDefault(),s(t,"Preview")}),$("#export-story").click(function(t){t.preventDefault(),s(t,"Export")}),$("#StoryOutput").click(function(){$(this).select()}),$("#story input[type=submit],#upload_story input[type=submit]").click(function(){$(this).attr("clicked","true")}),$("#clear-story").click(function(t){t.preventDefault(),confirm("Are you sure you want to clear all your story data?")&&e()}),$(".example-story").click(function(t){t.preventDefault(),$(".upload-progress").show();var r=$(this).attr("id")+".xml",n=d+r;e(),a(n,!1)}),$("#InputFile").on("change",r),$("#upload_story").on("submit",function(e){e.stopPropagation(),e.preventDefault();var r=t();if(null==c)return void alert("Please choose a file then try again");var n=new FormData;$.each(c,function(t,e){n.append(t,e)}),$.ajax({type:"POST",cache:!1,contentType:!1,processData:!1,url:u+"Upload.php",data:n,success:function(t){if("true"==t){$(".upload-progress").show();var e="Import Tags"==r?!0:!1;a(p,e)}}})}),$("#AddTag").click(function(t){t.preventDefault();var e=v+"_TagName",a=v+"_TagValue",r='<div id="d-'+e+'"><div class="col-md-5 s-block"><div class="panel panel-primary"><div class="panel-heading"><h3>Story Tag ['+v+']</h3><a class="tClear" href="#"><span class="d-'+e+' badge">X</span></a></div><div class="panel-body"><input id="'+e+'" name="'+e+'" type="text" class="form-control s-tag" placeholder="Ex. WEAPONS" value="" maxlength="16" size="16" spellcheck="true" /><br /><label for="'+a+'_1">Set your tag values:</label><div class="'+a+'"><p class="AddValue" id="'+a+'"><a href="#"><span>Add Values</span></a></p><input id="'+a+'_1" name="'+a+'_1" type="text" class="form-control s-value" placeholder="Ex. Magnificent Long Sword" value="" spellcheck="true" /></div><br /><a href="#top">[TOP]</a></div></div></div></div>';"AddTag"===t.target.id?$(".insert_blocks").append(r):$(".insert_blocks").prepend(r),$(".tClear").off("click").one("click",l);var n=2;$("#"+a).click(function(t){t.preventDefault();var e=$(this).attr("id"),a=e+"_"+n;$("."+e).append('<div id="d-'+a+'"><input id="'+a+'" name="'+a+'" type="text" class="form-control s-value" value="" spellcheck="true" /><a class="vClear" href="#"><span class="d-'+a+'"></span> Clear</a></div>'),this.clickid=a,n++,$(".vClear").click(l)}),v++}),$("#DeleteUnused").click(function(t){if(t.preventDefault(),confirm("Are you sure you want to delete your unused tags?")){o();for(var e=$("#StoryInput").val().match(/(\[.*?\]|\{.*?\}|\*.*?\*)\s?/g),a=!1,r=0;r<e.length;r++)e[r]=e[r].replace("[","").replace("]","").replace("{","").replace("}","").replace(/\*/g,""),e[r]=e[r].trim(),e[r]=e[r].toUpperCase();$(".s-tag").each(function(){var t=$(this).val().toUpperCase();if(t=t.trim(),-1===e.indexOf(t)){var r=$(this).attr("id");$("#d-"+r).remove(),o(),a=!0}}),a&&alert("Tag(s) Deleted")}})}();